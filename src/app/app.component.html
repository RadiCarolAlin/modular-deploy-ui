<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>üöÄ Platform Manager</h1>
        <p>Deploy, manage, and monitor your applications with ease</p>
    </div>

    <!-- Main Card -->
    <div class="main-card">

        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button
                    class="tab-button"
                    [class.active]="currentTab === 'deploy'"
                    (click)="currentTab = 'deploy'">
                Deploy Platform
            </button>
            <button
                    class="tab-button"
                    [class.active]="currentTab === 'add'"
                    (click)="currentTab = 'add'">
                Add Apps
            </button>
            <button
                    class="tab-button"
                    [class.active]="currentTab === 'remove'"
                    (click)="currentTab = 'remove'">
                Remove Apps
            </button>
            <button
                    class="tab-button delete"
                    [class.active]="currentTab === 'delete'"
                    (click)="currentTab = 'delete'">
                Delete Platform
            </button>
        </div>

        <!-- ========= PLATFORM STATUS CARD (dinamic + fallback) ========= -->

        <ng-container *ngIf="deploy.availablePlatforms().length > 0; else noPlatformsCard">
            <div class="tab-content" *ngIf="platform()">
                <div class="platform-status">
                    <div class="status-icon">
                        <span *ngIf="platform()!.status === 'active'">‚úÖ</span>
                        <span *ngIf="platform()!.status === 'deploying' || platform()!.status === 'updating'">‚öôÔ∏è</span>
                        <span *ngIf="platform()!.status === 'not_deployed'">‚≠ï</span>
                        <span *ngIf="platform()!.status === 'deleting'">üóëÔ∏è</span>
                    </div>
                    <div class="status-content">
                        <!-- header: titlu + dropdown namespaces -->
                        <div class="status-header-row">
                            <div class="status-label">Platform Status</div>

                            <!-- dropdown namespaces -->
                            <div class="status-namespace-selector"
                                 *ngIf="deploy.availablePlatforms().length > 0">
                                <span class="ns-select-label">Namespace</span>
                                <select
                                        class="ns-select"
                                        [(ngModel)]="namespace"
                                        (ngModelChange)="deploy.loadPlatform($event)">
                                    <option
                                            *ngFor="let p of deploy.availablePlatforms()"
                                            [ngValue]="p.namespace_name">
                                        {{ p.namespace_name }} ({{ p.deployed_apps?.length || 0 }} apps)
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="status-value"
                             [class.active]="platform()!.status === 'active'"
                             [class.deploying]="platform()!.status === 'deploying' || platform()!.status === 'updating'"
                             [class.not-deployed]="platform()!.status === 'not_deployed'">
                            {{ platform()!.status | titlecase }}
                        </div>

                        <div class="status-apps" *ngIf="platform()!.deployed_apps.length > 0">
                            <strong>Deployed:</strong>
                            <span class="deployed-app" *ngFor="let app of platform()!.deployed_apps; let last = last">
                                <span class="app-icon-small">{{ getAppIcon(app) }}</span>
                                <span>{{ app }}</span>
                                <span *ngIf="!last">,</span>
                            </span>
                        </div>
                        <div class="status-apps" *ngIf="platform()!.deployed_apps.length === 0">
                            <strong>No applications deployed</strong>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>

        <ng-template #noPlatformsCard>
            <div class="tab-content">
                <div class="platform-status">
                    <div class="status-icon">
                        <span>‚≠ï</span>
                    </div>
                    <div class="status-content">
                        <div class="status-label">Platform Status</div>
                        <div class="status-value not-deployed">
                            Not_deployed
                        </div>
                        <div class="status-apps">
                            <strong>No platform deployed yet</strong>
                        </div>
                    </div>
                </div>
            </div>
        </ng-template>

        <!-- ========== TAB 1: DEPLOY PLATFORM ========== -->
        <div class="tab-content" *ngIf="currentTab === 'deploy'">
            <h2>Deploy Complete Platform</h2>
            <p class="subtitle">Select applications to deploy. Frontend and Backend are required.</p>

            <div class="form-group">
                <label class="form-label">Branch</label>
                <input
                        class="form-input"
                        [(ngModel)]="branch"
                        placeholder="main" />
            </div>

            <div class="form-group">
                <label class="form-label">Platform Namespace / Name *</label>
                <input
                        class="form-input"
                        [(ngModel)]="namespace"
                        placeholder="e.g., my-platform, demo-env, prod-platform" />
            </div>

            <div class="form-group">
                <label class="form-label">Executive Management Account *</label>
                <input
                        class="form-input"
                        type="email"
                        [(ngModel)]="userEmail"
                        placeholder="your.email@company.com" />
            </div>

            <div class="apps-grid">
                <!-- Frontend (Required) -->
                <div class="app-card disabled">
                    <input type="checkbox" class="app-checkbox" [checked]="true" disabled />
                    <span class="app-icon">‚öõÔ∏è</span>
                    <span class="app-name">Frontend</span>
                    <span class="app-badge">Required</span>
                </div>

                <!-- Backend (Required) -->
                <div class="app-card disabled">
                    <input type="checkbox" class="app-checkbox" [checked]="true" disabled />
                    <span class="app-icon">üîß</span>
                    <span class="app-name">Backend</span>
                    <span class="app-badge">Required</span>
                </div>

                <!-- Gitea -->
                <div class="app-card" (click)="onToggleDeployGitea(!deployGitea())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="deployGitea()
                            "
                            (ngModelChange)="onToggleDeployGitea($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">ü¶ä</span>
                    <span class="app-name">Gitea</span>
                </div>

                <!-- Confluence -->
                <div class="app-card" (click)="onToggleDeployConfluence(!deployConfluence())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="deployConfluence()"
                            (ngModelChange)="onToggleDeployConfluence($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üìö</span>
                    <span class="app-name">Confluence</span>
                </div>

                <!-- Jira -->
                <div class="app-card" (click)="onToggleDeployJira(!deployJira())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="deployJira()"
                            (ngModelChange)="onToggleDeployJira($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üìã</span>
                    <span class="app-name">Jira</span>
                </div>

                <!-- Artifactory -->
                <div class="app-card" (click)="onToggleDeployArtifactory(!deployArtifactory())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="deployArtifactory()"
                            (ngModelChange)="onToggleDeployArtifactory($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üì¶</span>
                    <span class="app-name">Artifactory</span>
                </div>

                <!-- GitHub -->
                <div class="app-card" (click)="onToggleDeployGithub(!deployGithub())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="deployGithub()"
                            (ngModelChange)="onToggleDeployGithub($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üêô</span>
                    <span class="app-name">GitHub</span>
                </div>
            </div>

            <button class="btn btn-primary" (click)="runDeployPlatform()" [disabled]="running()">
                <span>üöÄ</span>
                <span>Deploy Platform</span>
            </button>
        </div>

        <!-- ========== TAB 2: ADD APPS ========== -->
        <div class="tab-content" *ngIf="currentTab === 'add'">
            <h2>Add Applications</h2>
            <p class="subtitle">Add new applications to your existing platform.</p>

            <div class="form-group">
                <label class="form-label">Branch</label>
                <input
                        class="form-input"
                        [(ngModel)]="branch"
                        placeholder="main" />
            </div>

            <div class="apps-grid">
                <!-- Gitea -->
                <div class="app-card"
                     [class.disabled]="isAppDeployed().gitea"
                     (click)="!isAppDeployed().gitea && onToggleAddGitea(!addGitea())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="addGitea()"
                            [disabled]="isAppDeployed().gitea"
                            (ngModelChange)="onToggleAddGitea($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">ü¶ä</span>
                    <span class="app-name">Gitea</span>
                    <span class="app-badge" *ngIf="isAppDeployed().gitea">Deployed</span>
                </div>

                <!-- Confluence -->
                <div class="app-card"
                     [class.disabled]="isAppDeployed().confluence"
                     (click)="!isAppDeployed().confluence && onToggleAddConfluence(!addConfluence())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="addConfluence()"
                            [disabled]="isAppDeployed().confluence"
                            (ngModelChange)="onToggleAddConfluence($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üìö</span>
                    <span class="app-name">Confluence</span>
                    <span class="app-badge" *ngIf="isAppDeployed().confluence">Deployed</span>
                </div>

                <!-- Jira -->
                <div class="app-card"
                     [class.disabled]="isAppDeployed().jira"
                     (click)="!isAppDeployed().jira && onToggleAddJira(!addJira())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="addJira()"
                            [disabled]="isAppDeployed().jira"
                            (ngModelChange)="onToggleAddJira($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üìã</span>
                    <span class="app-name">Jira</span>
                    <span class="app-badge" *ngIf="isAppDeployed().jira">Deployed</span>
                </div>

                <!-- Artifactory -->
                <div class="app-card"
                     [class.disabled]="isAppDeployed().artifactory"
                     (click)="!isAppDeployed().artifactory && onToggleAddArtifactory(!addArtifactory())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="addArtifactory()"
                            [disabled]="isAppDeployed().artifactory"
                            (ngModelChange)="onToggleAddArtifactory($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üì¶</span>
                    <span class="app-name">Artifactory</span>
                    <span class="app-badge" *ngIf="isAppDeployed().artifactory">Deployed</span>
                </div>

                <!-- GitHub -->
                <div class="app-card"
                     [class.disabled]="isAppDeployed().github"
                     (click)="!isAppDeployed().github && onToggleAddGithub(!addGithub())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="addGithub()"
                            [disabled]="isAppDeployed().github"
                            (ngModelChange)="onToggleAddGithub($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üêô</span>
                    <span class="app-name">GitHub</span>
                    <span class="app-badge" *ngIf="isAppDeployed().github">Deployed</span>
                </div>
            </div>

            <button class="btn btn-success" (click)="runAddApps()" [disabled]="running()">
                <span>‚ûï</span>
                <span>Add Selected Apps</span>
            </button>
        </div>

        <!-- ========== TAB 3: REMOVE APPS ========== -->
        <div class="tab-content" *ngIf="currentTab === 'remove'">
            <h2>Remove Applications</h2>
            <p class="subtitle">Remove applications from your platform. Frontend and Backend cannot be removed.</p>

            <div class="form-group">
                <label class="form-label">Branch</label>
                <input
                        class="form-input"
                        [(ngModel)]="branch"
                        placeholder="main" />
            </div>

            <div class="apps-grid">
                <!-- Gitea -->
                <div class="app-card"
                     [class.disabled]="!isAppDeployed().gitea"
                     (click)="isAppDeployed().gitea && onToggleRemoveGitea(!removeGitea())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="removeGitea()"
                            [disabled]="!isAppDeployed().gitea"
                            (ngModelChange)="onToggleRemoveGitea($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">ü¶ä</span>
                    <span class="app-name">Gitea</span>
                    <span class="app-badge" *ngIf="!isAppDeployed().gitea">Not Deployed</span>
                </div>

                <!-- Confluence -->
                <div class="app-card"
                     [class.disabled]="!isAppDeployed().confluence"
                     (click)="isAppDeployed().confluence && onToggleRemoveConfluence(!removeConfluence())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="removeConfluence()"
                            [disabled]="!isAppDeployed().confluence"
                            (ngModelChange)="onToggleRemoveConfluence($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üìö</span>
                    <span class="app-name">Confluence</span>
                    <span class="app-badge" *ngIf="!isAppDeployed().confluence">Not Deployed</span>
                </div>

                <!-- Jira -->
                <div class="app-card"
                     [class.disabled]="!isAppDeployed().jira"
                     (click)="isAppDeployed().jira && onToggleRemoveJira(!removeJira())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="removeJira()"
                            [disabled]="!isAppDeployed().jira"
                            (ngModelChange)="onToggleRemoveJira($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üìã</span>
                    <span class="app-name">Jira</span>
                    <span class="app-badge" *ngIf="!isAppDeployed().jira">Not Deployed</span>
                </div>

                <!-- Artifactory -->
                <div class="app-card"
                     [class.disabled]="!isAppDeployed().artifactory"
                     (click)="isAppDeployed().artifactory && onToggleRemoveArtifactory(!removeArtifactory())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="removeArtifactory()"
                            [disabled]="!isAppDeployed().artifactory"
                            (ngModelChange)="onToggleRemoveArtifactory($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üì¶</span>
                    <span class="app-name">Artifactory</span>
                    <span class="app-badge" *ngIf="!isAppDeployed().artifactory">Not Deployed</span>
                </div>

                <!-- GitHub -->
                <div class="app-card"
                     [class.disabled]="!isAppDeployed().github"
                     (click)="isAppDeployed().github && onToggleRemoveGithub(!removeGithub())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="removeGithub()"
                            [disabled]="!isAppDeployed().github"
                            (ngModelChange)="onToggleRemoveGithub($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-icon">üêô</span>
                    <span class="app-name">GitHub</span>
                    <span class="app-badge" *ngIf="!isAppDeployed().github">Not Deployed</span>
                </div>
            </div>

            <button class="btn btn-danger" (click)="runRemoveApps()" [disabled]="running()">
                <span>üóëÔ∏è</span>
                <span>Remove Selected Apps</span>
            </button>
        </div>

        <!-- ========== TAB 4: DELETE PLATFORM ========== -->
        <div class="tab-content" *ngIf="currentTab === 'delete'">
            <h2 style="color: #fca5a5;">‚ö†Ô∏è Delete Entire Platform</h2>
            <p class="subtitle">This will permanently delete the entire platform and all deployed applications.</p>

            <div class="warning-box">
                <div class="warning-title">
                    <span>‚ö†Ô∏è</span>
                    <span>Warning: This action cannot be undone!</span>
                </div>
                <ul class="warning-list">
                    <li>All applications will be undeployed</li>
                    <li>Platform data will be deleted from Firestore</li>
                    <li>You will need to deploy the platform again from scratch</li>
                </ul>
            </div>

            <div class="checkbox-confirm" (click)="deleteConfirmed = !deleteConfirmed">
                <input
                        type="checkbox"
                        [(ngModel)]="deleteConfirmed"
                        (click)="$event.stopPropagation()" />
                <label>I understand that this action is permanent and cannot be undone</label>
            </div>

            <div class="form-group">
                <label class="form-label">Branch</label>
                <input
                        class="form-input"
                        [(ngModel)]="branch"
                        placeholder="main" />
            </div>

            <button class="btn btn-danger" (click)="runDeletePlatform()" [disabled]="running() || !deleteConfirmed">
                <span>üóëÔ∏è</span>
                <span>Delete Entire Platform</span>
            </button>
        </div>

        <!-- ========== PROGRESS & LOGS (Shared across all tabs) ========== -->
        <div class="tab-content" *ngIf="running() || stableSteps().length > 0">

            <!-- Progress Bar with Distributed Icons -->
            <div class="progress-container" *ngIf="running()">
                <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="progress()"></div>
                    <div class="progress-content-distributed">
                        <div class="progress-icons-distributed">
                            <span class="progress-app-icon-distributed"
                                  *ngFor="let st of stableSteps(); let i = index"
                                  [class.completed]="st.status === 'SUCCESS' || st.status === 'DONE'"
                                  [style.left.%]="(i / (stableSteps().length - 1)) * 100">
                                {{ getAppIcon(st.id) }}
                            </span>
                        </div>
                        <div class="progress-percentage">{{ progress() }}%</div>
                    </div>
                </div>
            </div>

            <!-- Steps List (Anti-flickering with trackBy) -->
            <ul class="steps-list" *ngIf="stableSteps().length > 0">
                <li class="step-item" *ngFor="let st of stableSteps(); trackBy: trackByStepId">
                    <span class="step-icon">
                        <span *ngIf="st.id === 'frontend'">‚öõÔ∏è</span>
                        <span *ngIf="st.id === 'backend'">üîß</span>
                        <span *ngIf="st.id === 'gitea'">ü¶ä</span>
                        <span *ngIf="st.id === 'confluence'">üìö</span>
                        <span *ngIf="st.id === 'jira'">üìã</span>
                        <span *ngIf="st.id === 'artifactory'">üì¶</span>
                        <span *ngIf="st.id === 'github'">üêô</span>
                    </span>
                    <span class="step-name">{{ st.id }}</span>
                    <span class="step-status"
                          [class.running]="st.status === 'RUNNING'"
                          [class.success]="st.status === 'SUCCESS'"
                          [class.failure]="st.status === 'FAILURE'">
                        {{ st.status }}
                    </span>
                </li>
            </ul>

            <!-- Live Logs -->
            <div class="logs-section">
                <div class="logs-title">
                    <span>üì°</span>
                    <span>Live Logs</span>
                    <span *ngIf="logs().length > 0" style="margin-left: auto; font-size: 12px; opacity: 0.6;">
                        ({{ logs().length }} events)
                    </span>
                </div>
                <div class="logs-container" #logsContainer>
                    <div class="log-line" *ngFor="let e of logs(); trackBy: trackByLogTimestamp">
                        <span class="log-timestamp">{{ e.ts | date:'HH:mm:ss' }}</span>
                        <span class="log-separator">‚Äî</span>
                        <span class="log-message">{{ e.line }}</span>
                    </div>
                    <div *ngIf="logs().length === 0" style="color: rgba(255,255,255,0.4); text-align: center; padding: 40px 0;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üì°</div>
                        <div>Waiting for logs...</div>
                    </div>
                </div>
            </div>

            <!-- Status Message -->
            <div class="status-message" *ngIf="status()">
                {{ status() }}
            </div>

            <!-- Cloud Build Link -->
            <a *ngIf="logsUrl()" [href]="logsUrl()!" target="_blank" rel="noreferrer" class="cloud-build-link">
                <span>üîó</span>
                <span>Open Cloud Build Logs</span>
            </a>
        </div>

    </div>
</div>
