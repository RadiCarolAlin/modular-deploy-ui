<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>üöÄ Platform Manager</h1>
        <p>Deploy, manage, and monitor your applications with ease</p>
    </div>

    <!-- Main Card -->
    <div class="main-card">

        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button
                    class="tab-button"
                    [class.active]="currentTab === 'deploy'"
                    (click)="currentTab = 'deploy'">
                Deploy Platform
            </button>
            <button
                    class="tab-button"
                    [class.active]="currentTab === 'add'"
                    (click)="currentTab = 'add'">
                Add Apps
            </button>
            <button
                    class="tab-button"
                    [class.active]="currentTab === 'remove'"
                    (click)="currentTab = 'remove'">
                Remove Apps
            </button>
            <button
                    class="tab-button delete"
                    [class.active]="currentTab === 'delete'"
                    (click)="currentTab = 'delete'">
                Delete Platform
            </button>
        </div>

        <!-- Platform Status Card -->
        <div class="tab-content" *ngIf="platform()">
            <div class="platform-status">
                <div class="status-icon">
                    <span *ngIf="platform()!.status === 'active'">‚úÖ</span>
                    <span *ngIf="platform()!.status === 'deploying'">‚öôÔ∏è</span>
                    <span *ngIf="platform()!.status === 'not_deployed'">‚≠ï</span>
                </div>
                <div class="status-content">
                    <div class="status-label">Platform Status</div>
                    <div class="status-value" [class.active]="platform()!.status === 'active'"
                         [class.deploying]="platform()!.status === 'deploying'"
                         [class.not-deployed]="platform()!.status === 'not_deployed'">
                        {{ platform()!.status | titlecase }}
                    </div>
                    <div class="status-apps" *ngIf="platform()!.deployed_apps.length > 0">
                        <strong>Deployed:</strong> {{ platform()!.deployed_apps.join(', ') }}
                    </div>
                    <div class="status-apps" *ngIf="platform()!.deployed_apps.length === 0">
                        <strong>No applications deployed</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== TAB 1: DEPLOY PLATFORM ========== -->
        <div class="tab-content" *ngIf="currentTab === 'deploy'">
            <h2>Deploy Complete Platform</h2>
            <p class="subtitle">Select applications to deploy. Frontend and Backend are required.</p>

            <div class="form-group">
                <label class="form-label">Branch</label>
                <input
                        class="form-input"
                        [(ngModel)]="branch"
                        placeholder="main" />
            </div>

            <div class="apps-grid">
                <!-- Frontend (Required) -->
                <div class="app-card disabled">
                    <input type="checkbox" class="app-checkbox" [checked]="true" disabled />
                    <span class="app-name">Frontend</span>
                    <span class="app-badge">Required</span>
                </div>

                <!-- Backend (Required) -->
                <div class="app-card disabled">
                    <input type="checkbox" class="app-checkbox" [checked]="true" disabled />
                    <span class="app-name">Backend</span>
                    <span class="app-badge">Required</span>
                </div>

                <!-- Gitea -->
                <div class="app-card" (click)="onToggleDeployGitea(!deployGitea())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="deployGitea()"
                            (ngModelChange)="onToggleDeployGitea($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Gitea</span>
                </div>

                <!-- Confluence -->
                <div class="app-card" (click)="onToggleDeployConfluence(!deployConfluence())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="deployConfluence()"
                            (ngModelChange)="onToggleDeployConfluence($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Confluence</span>
                </div>

                <!-- Jira -->
                <div class="app-card" (click)="onToggleDeployJira(!deployJira())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="deployJira()"
                            (ngModelChange)="onToggleDeployJira($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Jira</span>
                </div>

                <!-- Artifactory -->
                <div class="app-card" (click)="onToggleDeployArtifactory(!deployArtifactory())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="deployArtifactory()"
                            (ngModelChange)="onToggleDeployArtifactory($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Artifactory</span>
                </div>

                <!-- GitHub -->
                <div class="app-card" (click)="onToggleDeployGithub(!deployGithub())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="deployGithub()"
                            (ngModelChange)="onToggleDeployGithub($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">GitHub</span>
                </div>
            </div>

            <button class="btn btn-primary" (click)="runDeployPlatform()" [disabled]="running()">
                <span>üöÄ</span>
                <span>Deploy Platform</span>
            </button>
        </div>

        <!-- ========== TAB 2: ADD APPS ========== -->
        <div class="tab-content" *ngIf="currentTab === 'add'">
            <h2>Add Applications</h2>
            <p class="subtitle">Add new applications to your existing platform.</p>

            <div class="form-group">
                <label class="form-label">Branch</label>
                <input
                        class="form-input"
                        [(ngModel)]="branch"
                        placeholder="main" />
            </div>

            <div class="apps-grid">
                <div class="app-card" (click)="onToggleAddGitea(!addGitea())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="addGitea()"
                            (ngModelChange)="onToggleAddGitea($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Gitea</span>
                </div>

                <div class="app-card" (click)="onToggleAddConfluence(!addConfluence())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="addConfluence()"
                            (ngModelChange)="onToggleAddConfluence($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Confluence</span>
                </div>

                <div class="app-card" (click)="onToggleAddJira(!addJira())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="addJira()"
                            (ngModelChange)="onToggleAddJira($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Jira</span>
                </div>

                <div class="app-card" (click)="onToggleAddArtifactory(!addArtifactory())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="addArtifactory()"
                            (ngModelChange)="onToggleAddArtifactory($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Artifactory</span>
                </div>

                <div class="app-card" (click)="onToggleAddGithub(!addGithub())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="addGithub()"
                            (ngModelChange)="onToggleAddGithub($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">GitHub</span>
                </div>
            </div>

            <button class="btn btn-success" (click)="runAddApps()" [disabled]="running()">
                <span>‚ûï</span>
                <span>Add Selected Apps</span>
            </button>
        </div>

        <!-- ========== TAB 3: REMOVE APPS ========== -->
        <div class="tab-content" *ngIf="currentTab === 'remove'">
            <h2>Remove Applications</h2>
            <p class="subtitle">Remove applications from your platform. Frontend and Backend cannot be removed.</p>

            <div class="form-group">
                <label class="form-label">Branch</label>
                <input
                        class="form-input"
                        [(ngModel)]="branch"
                        placeholder="main" />
            </div>

            <div class="apps-grid">
                <div class="app-card" (click)="onToggleRemoveGitea(!removeGitea())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="removeGitea()"
                            (ngModelChange)="onToggleRemoveGitea($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Gitea</span>
                </div>

                <div class="app-card" (click)="onToggleRemoveConfluence(!removeConfluence())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="removeConfluence()"
                            (ngModelChange)="onToggleRemoveConfluence($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Confluence</span>
                </div>

                <div class="app-card" (click)="onToggleRemoveJira(!removeJira())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="removeJira()"
                            (ngModelChange)="onToggleRemoveJira($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Jira</span>
                </div>

                <div class="app-card" (click)="onToggleRemoveArtifactory(!removeArtifactory())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="removeArtifactory()"
                            (ngModelChange)="onToggleRemoveArtifactory($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">Artifactory</span>
                </div>

                <div class="app-card" (click)="onToggleRemoveGithub(!removeGithub())">
                    <input
                            type="checkbox"
                            class="app-checkbox"
                            [ngModel]="removeGithub()"
                            (ngModelChange)="onToggleRemoveGithub($event)"
                            (click)="$event.stopPropagation()" />
                    <span class="app-name">GitHub</span>
                </div>
            </div>

            <button class="btn btn-danger" (click)="runRemoveApps()" [disabled]="running()">
                <span>üóëÔ∏è</span>
                <span>Remove Selected Apps</span>
            </button>
        </div>

        <!-- ========== TAB 4: DELETE PLATFORM ========== -->
        <div class="tab-content" *ngIf="currentTab === 'delete'">
            <h2 style="color: #fca5a5;">‚ö†Ô∏è Delete Entire Platform</h2>
            <p class="subtitle">This will permanently delete the entire platform and all deployed applications.</p>

            <div class="warning-box">
                <div class="warning-title">
                    <span>‚ö†Ô∏è</span>
                    <span>Warning: This action cannot be undone!</span>
                </div>
                <ul class="warning-list">
                    <li>All applications will be undeployed</li>
                    <li>Platform data will be deleted from Firestore</li>
                    <li>You will need to deploy the platform again from scratch</li>
                </ul>
            </div>

            <div class="checkbox-confirm" (click)="deleteConfirmed = !deleteConfirmed">
                <input
                        type="checkbox"
                        [(ngModel)]="deleteConfirmed"
                        (click)="$event.stopPropagation()" />
                <label>I understand that this action is permanent and cannot be undone</label>
            </div>

            <div class="form-group">
                <label class="form-label">Branch</label>
                <input
                        class="form-input"
                        [(ngModel)]="branch"
                        placeholder="main" />
            </div>

            <button class="btn btn-danger" (click)="runDeletePlatform()" [disabled]="running() || !deleteConfirmed">
                <span>üóëÔ∏è</span>
                <span>Delete Entire Platform</span>
            </button>
        </div>

        <!-- ========== PROGRESS & LOGS (Shared across all tabs) ========== -->
        <div class="tab-content" *ngIf="running() || steps().length > 0">

            <!-- Progress Bar -->
            <div class="progress-container" *ngIf="running()">
                <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="progress()"></div>
                </div>
            </div>

            <!-- Steps List -->
            <ul class="steps-list" *ngIf="steps().length > 0">
                <li class="step-item" *ngFor="let st of steps()">
                    <span class="step-name">{{ st.id }}</span>
                    <span class="step-status"
                          [class.running]="st.status === 'RUNNING'"
                          [class.success]="st.status === 'SUCCESS'"
                          [class.failure]="st.status === 'FAILURE'">
            {{ st.status }}
          </span>
                </li>
            </ul>

            <!-- Live Logs -->
            <div class="logs-section">
                <div class="logs-title">
                    <span>üì°</span>
                    <span>Live Logs</span>
                </div>
                <div class="logs-container">
                    <div class="log-line" *ngFor="let e of deploy.logs()">
                        <span class="log-timestamp">{{ e.ts | date:'mediumTime' }}</span>
                        <span class="log-separator">‚Äî</span>
                        <span class="log-message">{{ e.line }}</span>
                    </div>
                    <div *ngIf="deploy.logs().length === 0" style="color: rgba(255,255,255,0.4); text-align: center; padding: 40px 0;">
                        No logs yet...
                    </div>
                </div>
            </div>

            <!-- Status Message -->
            <div class="status-message" *ngIf="status()">
                {{ status() }}
            </div>

            <!-- Cloud Build Link -->
            <a *ngIf="logsUrl()" [href]="logsUrl()!" target="_blank" rel="noreferrer" class="cloud-build-link">
                <span>üîó</span>
                <span>Open Cloud Build Logs</span>
            </a>
        </div>

    </div>
</div>